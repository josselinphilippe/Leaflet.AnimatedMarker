/*globals L $*/

// This demo is based off of cibi.me by OpenPlans and my earlier visualization
// at http://github.com/openplans/cibi_animation

(function(){
  var bikeIcon = L.icon({
      iconUrl: 'marker-bike-green-shadowed.png',
      iconSize: [25, 39],
      iconAnchor: [12, 39],
      shadowUrl: null
  });

  var config = {
      tileUrl : 'http://{s}.tiles.mapbox.com/v3/openplans.map-g4j0dszr/{z}/{x}/{y}.png',
      overlayTileUrl : 'http://{s}.tiles.mapbox.com/v3/intertwine.nyc_bike_overlay/{z}/{x}/{y}.png',
      tileAttrib : 'Routing powered by <a href="http://opentripplanner.org/">OpenTripPlanner</a>, Map tiles &copy; Development Seed and OpenStreetMap ',
      initLatLng : new L.LatLng(40.719298,-73.999743), // NYC
      initZoom : 11,
      minZoom : 13,
      maxZoom : 17
  };
    


  var map = L.map('map', {minZoom: config.minZoom, maxZoom: config.maxZoom}),
      routeLines = [
        L.polyline([[40.7341526254144,-73.9582872390747],[40.7339575116741,-73.9598965644836],[40.726152492869,-73.9586734771729],[40.7263313681328,-73.9574074745178],[40.7241035237349,-73.9578151702881],[40.7162810853358,-73.9661192893982],[40.7108655206047,-73.9685440063477],[40.706864174918,-73.9684581756592],[40.7042610365273,-73.9672780036926],[40.7005033095797,-73.9625573158264],[40.699559777742,-73.9623212814331],[40.6980631136214,-73.9629006385803],[40.6977052106976,-73.9654111862183],[40.6982425724961,-73.9805388450623],[40.6996736529833,-73.980495929718],[40.7000155314752,-73.9853882789612],[40.7002432804531,-73.9861714839935],[40.7003002175138,-73.9886927604675],[40.7016097564788,-73.9886498451233],[40.7017561629618,-73.9907205104828],[40.7025695264516,-73.991664648056],[40.7024719231091,-73.9931452277597],[40.7029599371506,-73.9947760108407],[40.7025776597882,-73.995087146759],[40.7024881903014,-73.9958703517914],[40.7007882472185,-73.9966213703156],[40.6994705581397,-73.997415304184],[40.6984294026558,-73.9976620674133],[40.6963063711325,-73.9990139007568],[40.6953302419806,-73.9999151229858],[40.6929793389086,-74.0015029907227],[40.691799787823,-74.0008163452148],[40.6915313365676,-73.9997756481171],[40.6897090866581,-74.0006017691485],[40.6858935875278,-74.0024149417877],[40.6864224008117,-74.004453420639],[40.6832413222241,-74.006062746048],[40.683583031039,-74.0066742897034],[40.6825823094059,-74.0079510218493],[40.6829565655264,-74.0085196501605],[40.679954321376,-74.0124893188477],[40.679726503292,-74.0123605728149],[40.677912067187,-74.0095925331116],[40.6752594842808,-74.012736082077],[40.6736158063308,-74.0103328227997],[40.6738110969213,-74.0102362632751],[40.6709874648145,-73.9999687671661],[40.6722731680365,-73.9993894100189],[40.6722487561809,-73.9990675449371],[40.6691321025427,-73.9971256256104],[40.6671546201347,-73.9962995055612],[40.6652665986749,-73.9967608451843],[40.6640865581204,-73.9978444576263],[40.6410593827835,-74.0218663215637],[40.6394229992988,-74.023529291153],[40.6377784381839,-74.0250742435455],[40.6388693931649,-74.0275955200195],[40.6396835240897,-74.030374288559],[40.6389589480527,-74.03200507164],[40.6389752267713,-74.033077955246],[40.6397567914107,-74.0355885028839],[40.6388205449937,-74.0360069274902],[40.6390319657273,-74.0367364883423],[40.6307761384738,-74.0407061576843],[40.6301410324786,-74.0410494804382],[40.6265256986826,-74.0416288375854],[40.6205159946172,-74.0415000915527],[40.6149455414314,-74.0401911735535],[40.5985572478288,-74.0071034431458],[40.596944265284,-74.0045714378357],[40.5921050891246,-73.9953231811523],[40.5873633324541,-73.9922976467642],[40.6107429625598,-74.0366291999817],[40.6093257544018,-74.0361142158508],[40.6084135125614,-74.0345692634583],[40.6052694404313,-74.0308356285095],[40.6032493375077,-74.0198493003845],[40.6025488025215,-74.0185618400574],[40.6013920907909,-74.0120816230774],[40.5957548701221,-74.0006446838379],[40.5851960258731,-73.9903879139456],[40.5836642029217,-73.9883708927664],[40.5836316105629,-73.9867186520132],[40.5789055504259,-73.9853024482728],[40.5798181949486,-73.9760756492615],[40.5803722944772,-73.9677715301514],[40.5827516108709,-73.9560127258301],[40.5837619779137,-73.9485454506939],[40.5839412353414,-73.9385676331585],[40.5843486367996,-73.9311218209332],[40.5840553079998,-73.9263582229614],[40.5837456817601,-73.9187622070312],[40.5852612070611,-73.9132475852966],[40.5866626319941,-73.9107584953308],[40.5890417246321,-73.9082479476929],[40.5909481966855,-73.9076900377404],[40.5937833622941,-73.9081406488549],[40.5940603547867,-73.9059090509545],[40.5930175535489,-73.9042353525292],[40.5899868201359,-73.9012312784325],[40.5905734244201,-73.9003300562035],[40.5903290065937,-73.9007377519738],[40.5942721718009,-73.905093659414],[40.5989482687929,-73.9048147096764],[40.6010825458145,-73.9005446434021],[40.6035909390326,-73.8986349105835],[40.6089668582713,-73.8973903656006],[40.6177628882276,-73.8969612121582],[40.6223559082055,-73.8965320587158],[40.6252223138105,-73.8936138153076],[40.6303685060717,-73.885760307312],[40.6295542615536,-73.884859085083],[40.6327134787869,-73.8826704025269],[40.6374357353533,-73.8787651062012],[40.6451534631728,-73.874773979187],[40.6495166761126,-73.8694524765015],[40.6530982065047,-73.8623714447021],[40.6604234673501,-73.8526725769043],[40.6622554193739,-73.8493466377258],[40.6612950687355,-73.8491106033326],[40.6622554193739,-73.8426196575165],[40.6488418128174,-73.8393151760101],[40.6491104369816,-73.8375020027161],[40.6455612547306,-73.8366436958313],[40.6448367424958,-73.8363325595856],[40.6386984224216,-73.8329744338989],[40.6357593196376,-73.8307857513428],[40.6327712368519,-73.8293159008026],[40.6294328893678,-73.8283288374078],[40.6240830482576,-73.8268160715234],[40.6193354161445,-73.8252818584442],[40.6172587299861,-73.8238763809204],[40.6139196090585,-73.8210010423791],[40.6119079117527,-73.8195204734802],[40.6102789626758,-73.8190913095605],[40.6084870728269,-73.8192736997735],[40.5984190166071,-73.8208722963464],[40.5966021146683,-73.8213443546556],[40.5903290065937,-73.8195204525255],[40.5877544178906,-73.8192844181322],[40.587477399276,-73.8189625530504],[40.5859784744254,-73.823254108429],[40.5822629638262,-73.8208293914795],[40.5850577660331,-73.8095104589593],[40.5875588754582,-73.8178252964281],[40.5883247467194,-73.8177394657396],[40.588259566528,-73.8182544498704],[40.5845851851218,-73.8123106956482],[40.5853103510129,-73.8096070184839]])
      ],
      markers = [];

  map.addLayer(new L.TileLayer(config.tileUrl, {attribution: config.tileAttrib}));
  map.addLayer(new L.TileLayer(config.overlayTileUrl));
  map.setView(config.initLatLng, config.initZoom);


  $.each(routeLines, function(i, routeLine) {
//    var animatedMarker = L.animatedMarker(line.getLatLngs(), {
//  distance: 300,  // meters
//  interval: 2000, // milliseconds
//    });
    var marker = L.animatedMarker(routeLine.getLatLngs(), {
         distance: 300,  // meters
  interval: 500,
      icon: bikeIcon,
      autoStart: false,
      onEnd: function() {
        $(this._shadow).fadeOut();
        $(this._icon).fadeOut(3000, function(){
          map.removeLayer(this);
        });
      }
    });

    map.addLayer(marker);
    markers.push(marker);
  });

 $(function() {
  $('#start').click(function() {
    console.log('start');
    $.each(markers, function(i, marker) {
      marker.start();
    });

    $(this).hide();
  });
 });
}());